<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOB Test Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
        }

        .sidebar h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(5px);
        }

        .btn-primary {
            background: rgba(255,255,255,0.3);
            font-weight: bold;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 280px;
            overflow-y: auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .worksheet-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table-container {
            overflow-x: auto;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-save {
            background: #28a745;
            color: white;
        }

        .btn-save:hover {
            background: #218838;
        }

        .btn-random {
            background: #ffc107;
            color: #333;
        }

        .btn-random:hover {
            background: #e0a800;
        }

        .btn-add-time {
            background: #17a2b8;
            color: white;
        }

        .btn-add-time:hover {
            background: #138496;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .language-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .language-toggle button {
            padding: 8px 15px;
            border: 1px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }

        .language-toggle button.active {
            background: white;
            color: #667eea;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-normal {
            background: #d4edda;
            color: #155724;
        }

        .status-abnormal {
            background: #f8d7da;
            color: #721c24;
        }

        .mode-selector {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mode-btn {
            padding: 10px 15px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            text-align: left;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
            font-weight: bold;
        }

        .group-selector {
            margin: 20px 0;
        }

        .group-selector select {
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            width: 100%;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .group-selector select option {
            background: #667eea;
            color: white;
        }

        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .time-input-group input {
            width: 100px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .summary-table {
            width: 100%;
            margin: 20px 0;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="language-toggle">
                <button class="lang-btn active" data-lang="en" onclick="setLanguage('en')">EN</button>
                <button class="lang-btn" data-lang="zh" onclick="setLanguage('zh')">‰∏≠Êñá</button>
            </div>
            <h2 data-i18n="app_title">FOB Test Dashboard</h2>
            
            <div class="sidebar-section">
                <h3 data-i18n="project_management">Project Management</h3>
                <button class="btn btn-primary" onclick="showCreateProjectModal()" data-i18n="create_project">‚ûï Create Project</button>
                <select id="projectSelect" class="btn" onchange="selectProject()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <option value="" data-i18n="select_project">Select Project...</option>
                </select>
                <button class="btn" onclick="exportProject()" data-i18n="export_project">üì§ Export</button>
                <button class="btn" onclick="importProject()" data-i18n="import_project">üì• Import</button>
                <button class="btn" onclick="deleteProject()" data-i18n="delete_project">üóëÔ∏è Delete</button>
            </div>

            <div class="sidebar-section">
                <h3 data-i18n="analysis_modes">Analysis Modes</h3>
                <div class="mode-selector" id="modeSelector"></div>
            </div>

            <div class="sidebar-section">
                <h3 data-i18n="experiment_groups">Experiment Groups</h3>
                <div class="group-selector">
                    <select id="groupSelect" onchange="selectGroup()">
                        <option value="" data-i18n="select_group">Select Group...</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 data-i18n="views">Views</h3>
                <button class="btn" onclick="showWorksheet()" data-i18n="data_entry">üìù Data Entry</button>
                <button class="btn" onclick="showSummary()" data-i18n="summary_view">üìä Summary</button>
                <button class="btn" onclick="showCharts()" data-i18n="visualization">üìà Charts</button>
            </div>

            <div class="sidebar-section">
                <h3 data-i18n="ai_features">AI Features</h3>
                <button class="btn" onclick="showAIChatbot()" data-i18n="ai_chatbot">üí¨ AI Chatbot</button>
                <button class="btn" onclick="generateAIReport()" data-i18n="ai_report">üìä AI Report</button>
                <button class="btn" onclick="generatePowerPoint()" data-i18n="powerpoint">üìà PowerPoint</button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1 data-i18n="main_title">FOB Test Analysis Dashboard</h1>
                <p data-i18n="main_subtitle">Visualize and compare Functional Observational Battery (FOB) test results</p>
            </div>

            <div id="worksheetArea" class="worksheet-container" style="display: none;">
                <h2 data-i18n="data_worksheet">Data Entry Worksheet</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('manual')" data-i18n="manual_save">Manual Save</button>
                    <button class="tab" onclick="switchTab('auto')" data-i18n="auto_save">Auto Save</button>
                    <button class="tab" onclick="switchTab('upload')" data-i18n="upload_data">Upload Data</button>
                </div>

                <div id="manualTab" class="tab-content active">
                    <div class="time-input-group">
                        <label data-i18n="add_time">Add Time Point (min):</label>
                        <input type="number" id="newTimeInput" min="0" max="300" step="5" value="0">
                        <button class="btn-action btn-add-time" onclick="addTimePoint()" data-i18n="add">Add</button>
                    </div>
                    <div class="data-table-container">
                        <div id="worksheetTable"></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn-action btn-save" onclick="saveData()" data-i18n="save_changes">üíæ Save Changes</button>
                        <button class="btn-action btn-random" onclick="fillRandomData()" data-i18n="fill_random">üé≤ Random Data</button>
                        <button class="btn-action" onclick="resetData()" data-i18n="reset">üîÑ Reset</button>
                    </div>
                </div>

                <div id="autoTab" class="tab-content">
                    <div class="alert alert-info" data-i18n="auto_save_info">Changes are saved automatically</div>
                    <div class="time-input-group">
                        <label data-i18n="add_time">Add Time Point (min):</label>
                        <input type="number" id="newTimeInputAuto" min="0" max="300" step="5" value="0">
                        <button class="btn-action btn-add-time" onclick="addTimePoint()" data-i18n="add">Add</button>
                    </div>
                    <div class="data-table-container">
                        <div id="worksheetTableAuto"></div>
                    </div>
                </div>

                <div id="uploadTab" class="tab-content">
                    <div class="alert alert-info" data-i18n="upload_info">Upload CSV or Excel file</div>
                    <input type="file" id="fileUpload" accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
                    <div class="export-buttons">
                        <button class="btn-action" onclick="exportCSV()" data-i18n="export_csv">üì• Export CSV</button>
                        <button class="btn-action" onclick="downloadTemplate()" data-i18n="download_template">üìã Download Template</button>
                    </div>
                </div>
            </div>

            <div id="summaryArea" class="worksheet-container" style="display: none;">
                <h2 data-i18n="summary_view">Summary View</h2>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="showSummaryType('mean')" data-i18n="mean_scores">Mean Scores</button>
                    <button class="view-btn" onclick="showSummaryType('comparative')" data-i18n="comparative">Comparative</button>
                    <button class="view-btn" onclick="showSummaryType('abnormal')" data-i18n="abnormal_episodes">Abnormal Episodes</button>
                </div>
                <div id="summaryContent"></div>
            </div>

            <div id="chartArea" class="chart-container" style="display: none;">
                <h2 data-i18n="visualization">Visualization</h2>
                <div style="margin: 20px 0;">
                    <label data-i18n="select_groups_chart">Select Groups to Plot:</label>
                    <div id="groupCheckboxes" style="margin: 10px 0;"></div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chartCanvas"></canvas>
                </div>
                <div id="chartControls" style="margin: 20px 0;"></div>
            </div>

            <div id="aiChatbotArea" style="display: none;">
                <div class="worksheet-container">
                    <h2 data-i18n="ai_chatbot">AI Chatbot</h2>
                    <div id="chatMessages" style="max-height: 400px; overflow-y: auto; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="chatInput" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn-action btn-save" onclick="sendChatMessage()" data-i18n="send">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <h2 data-i18n="create_project">Create New Project</h2>
            <div class="form-group">
                <label data-i18n="project_name">Project Name:</label>
                <input type="text" id="projectNameInput" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label data-i18n="animal_type">Animal Type:</label>
                <select id="animalTypeSelect" onchange="toggleCustomAnimal()">
                    <option value="mouse" data-i18n="mouse">Mouse</option>
                    <option value="rat" data-i18n="rat">Rat</option>
                    <option value="custom" data-i18n="custom">Custom</option>
                </select>
            </div>
            <div class="form-group" id="customAnimalGroup" style="display: none;">
                <label data-i18n="custom_animal_name">Custom Animal Name:</label>
                <input type="text" id="customAnimalInput" placeholder="Enter animal name">
            </div>
            <div class="form-group">
                <label data-i18n="animals_per_group">Animals per Group:</label>
                <input type="number" id="animalsPerGroupInput" min="1" max="50" value="8">
            </div>
            <div class="form-group">
                <label data-i18n="num_groups">Number of Groups:</label>
                <input type="number" id="numGroupsInput" min="1" max="10" value="3">
            </div>
            <div class="btn-group">
                <button class="btn-action btn-save" onclick="createProject()" data-i18n="create">Create</button>
                <button class="btn-action" onclick="closeModal('createProjectModal')" data-i18n="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        const state = {
            projects: {},
            activeProject: null,
            activeMode: 'General Behavior',
            activeGroup: null,
            currentTab: 'manual',
            language: 'en',
            chatMessages: [],
            worksheetData: {},
            currentChart: null,
            selectedGroupsForChart: []
        };

        // Translation dictionary
        const translations = {
            en: {
                app_title: 'FOB Test Dashboard',
                project_management: 'Project Management',
                create_project: '‚ûï Create Project',
                select_project: 'Select Project...',
                export_project: 'üì§ Export',
                import_project: 'üì• Import',
                delete_project: 'üóëÔ∏è Delete',
                analysis_modes: 'Analysis Modes',
                experiment_groups: 'Experiment Groups',
                select_group: 'Select Group...',
                views: 'Views',
                data_entry: 'üìù Data Entry',
                summary_view: 'üìä Summary',
                visualization: 'üìà Charts',
                ai_features: 'AI Features',
                ai_chatbot: 'üí¨ AI Chatbot',
                ai_report: 'üìä AI Report',
                powerpoint: 'üìà PowerPoint',
                main_title: 'FOB Test Analysis Dashboard',
                main_subtitle: 'Visualize and compare Functional Observational Battery (FOB) test results',
                data_worksheet: 'Data Entry Worksheet',
                manual_save: 'Manual Save',
                auto_save: 'Auto Save',
                upload_data: 'Upload Data',
                add_time: 'Add Time Point (min):',
                add: 'Add',
                save_changes: 'üíæ Save Changes',
                fill_random: 'üé≤ Random Data',
                reset: 'üîÑ Reset',
                auto_save_info: 'Changes are saved automatically',
                upload_info: 'Upload CSV or Excel file',
                export_csv: 'üì• Export CSV',
                download_template: 'üìã Download Template',
                mean_scores: 'Mean Scores',
                comparative: 'Comparative',
                abnormal_episodes: 'Abnormal Episodes',
                select_groups_chart: 'Select Groups to Plot:',
                send: 'Send',
                project_name: 'Project Name:',
                animal_type: 'Animal Type:',
                mouse: 'Mouse',
                rat: 'Rat',
                custom: 'Custom',
                custom_animal_name: 'Custom Animal Name:',
                animals_per_group: 'Animals per Group:',
                num_groups: 'Number of Groups:',
                create: 'Create',
                cancel: 'Cancel'
            },
            zh: {
                app_title: 'FOBÊµãËØï‰ª™Ë°®Êùø',
                project_management: 'È°πÁõÆÁÆ°ÁêÜ',
                create_project: '‚ûï ÂàõÂª∫È°πÁõÆ',
                select_project: 'ÈÄâÊã©È°πÁõÆ...',
                export_project: 'üì§ ÂØºÂá∫',
                import_project: 'üì• ÂØºÂÖ•',
                delete_project: 'üóëÔ∏è Âà†Èô§',
                analysis_modes: 'ÂàÜÊûêÊ®°Âºè',
                experiment_groups: 'ÂÆûÈ™åÁªÑ',
                select_group: 'ÈÄâÊã©ÁªÑ...',
                views: 'ËßÜÂõæ',
                data_entry: 'üìù Êï∞ÊçÆÂΩïÂÖ•',
                summary_view: 'üìä ÊëòË¶Å',
                visualization: 'üìà ÂõæË°®',
                ai_features: 'AIÂäüËÉΩ',
                ai_chatbot: 'üí¨ AIËÅäÂ§©Êú∫Âô®‰∫∫',
                ai_report: 'üìä AIÊä•Âëä',
                powerpoint: 'üìà PowerPoint',
                main_title: 'FOBÊµãËØïÂàÜÊûê‰ª™Ë°®Êùø',
                main_subtitle: 'ÂèØËßÜÂåñÂíåÊØîËæÉÂäüËÉΩËßÇÂØüÁîµÊ±†(FOB)ÊµãËØïÁªìÊûú',
                data_worksheet: 'Êï∞ÊçÆÂΩïÂÖ•Â∑•‰ΩúË°®',
                manual_save: 'ÊâãÂä®‰øùÂ≠ò',
                auto_save: 'Ëá™Âä®‰øùÂ≠ò',
                upload_data: '‰∏ä‰º†Êï∞ÊçÆ',
                add_time: 'Ê∑ªÂä†Êó∂Èó¥ÁÇπ(ÂàÜÈíü):',
                add: 'Ê∑ªÂä†',
                save_changes: 'üíæ ‰øùÂ≠òÊõ¥Êîπ',
                fill_random: 'üé≤ ÈöèÊú∫Êï∞ÊçÆ',
                reset: 'üîÑ ÈáçÁΩÆ',
                auto_save_info: 'Êõ¥Êîπ‰ºöËá™Âä®‰øùÂ≠ò',
                upload_info: '‰∏ä‰º†CSVÊàñExcelÊñá‰ª∂',
                export_csv: 'üì• ÂØºÂá∫CSV',
                download_template: 'üìã ‰∏ãËΩΩÊ®°Êùø',
                mean_scores: 'Âπ≥ÂùáÂæóÂàÜ',
                comparative: 'ÊØîËæÉÂàÜÊûê',
                abnormal_episodes: 'ÂºÇÂ∏∏‰∫ã‰ª∂',
                select_groups_chart: 'ÈÄâÊã©Ë¶ÅÁªòÂà∂ÁöÑÁªÑ:',
                send: 'ÂèëÈÄÅ',
                project_name: 'È°πÁõÆÂêçÁß∞:',
                animal_type: 'Âä®Áâ©Á±ªÂûã:',
                mouse: 'Â∞èÈº†',
                rat: 'Â§ßÈº†',
                custom: 'Ëá™ÂÆö‰πâ',
                custom_animal_name: 'Ëá™ÂÆö‰πâÂä®Áâ©ÂêçÁß∞:',
                animals_per_group: 'ÊØèÁªÑÂä®Áâ©Êï∞:',
                num_groups: 'ÁªÑÊï∞:',
                create: 'ÂàõÂª∫',
                cancel: 'ÂèñÊ∂à'
            }
        };

        // Analysis modes
        const MODES = [
            'General Behavior',
            'Autonomic and Sensorimotor Functions',
            'Reflex Capabilities',
            'Body Temperature',
            'Body Weight',
            'Convulsive Behaviors and Excitability'
        ];

        const MODE_OBSERVATIONS = {
            'General Behavior': ['spontaneous exploration', 'grooming', 'smelling its congeners', 'normal resting state', 'alertness', 'distending / oedema', 'bad condition', 'moribund', 'dead'],
            'Autonomic and Sensorimotor Functions': ['piloerection', 'skin color', 'respiratory activity', 'irregular breathing', 'stertorous'],
            'Reflex Capabilities': ['startle response', 'touch reactivity', 'vocalization', 'abnormal gait', 'corneal reflex', 'pinna reflex', 'catalepsy', 'grip reflex', 'pulling reflex', 'righting reflex', 'body tone', 'pain response'],
            'Body Temperature': ['body temperature'],
            'Body Weight': ['body weight'],
            'Convulsive Behaviors and Excitability': ['spontaneous activity', 'restlessness', 'fighting', 'writhing', 'tremor', 'stereotypy', 'twitches / jerks', 'straub', 'opisthotonus', 'convulsion']
        };

        // Initialize
        function init() {
            setupModeSelector();
            loadFromLocalStorage();
            updateUI();
            updateTranslations();
        }

        function setLanguage(lang) {
            state.language = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            updateTranslations();
        }

        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[state.language] && translations[state.language][key]) {
                    if (el.tagName === 'INPUT' && el.type !== 'submit' && el.type !== 'file') {
                        el.placeholder = translations[state.language][key];
                    } else if (el.tagName !== 'INPUT' && el.tagName !== 'OPTION') {
                        el.textContent = translations[state.language][key];
                    }
                }
            });
        }

        function setupModeSelector() {
            const selector = document.getElementById('modeSelector');
            selector.innerHTML = '';
            MODES.forEach(mode => {
                const btn = document.createElement('button');
                btn.className = 'mode-btn';
                btn.textContent = mode;
                btn.onclick = () => selectMode(mode);
                if (mode === state.activeMode) btn.classList.add('active');
                selector.appendChild(btn);
            });
        }

        function selectMode(mode) {
            state.activeMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === mode);
            });
            if (state.activeProject && state.activeGroup) {
                updateWorksheet();
                updateCharts();
            }
        }

        function showCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleCustomAnimal() {
            const select = document.getElementById('animalTypeSelect');
            document.getElementById('customAnimalGroup').style.display = 
                select.value === 'custom' ? 'block' : 'none';
        }

        function createProject() {
            const name = document.getElementById('projectNameInput').value;
            const animalType = document.getElementById('animalTypeSelect').value;
            const customAnimal = document.getElementById('customAnimalInput').value;
            const animalsPerGroup = parseInt(document.getElementById('animalsPerGroupInput').value);
            const numGroups = parseInt(document.getElementById('numGroupsInput').value);

            if (!name) {
                alert('Please enter a project name');
                return;
            }

            const projectId = 'project_' + Date.now();
            state.projects[projectId] = {
                id: projectId,
                name: name,
                animalType: animalType,
                customAnimal: customAnimal || animalType,
                animalsPerGroup: animalsPerGroup,
                numGroups: numGroups,
                groups: []
            };

            // Create groups
            for (let i = 1; i <= numGroups; i++) {
                const groupName = `Group_${i}`;
                state.projects[projectId].groups.push(groupName);
                initializeGroupData(projectId, groupName);
            }

            state.activeProject = projectId;
            state.activeGroup = state.projects[projectId].groups[0];
            saveToLocalStorage();
            updateUI();
            closeModal('createProjectModal');
            
            // Reset form
            document.getElementById('projectNameInput').value = '';
            document.getElementById('animalsPerGroupInput').value = '8';
            document.getElementById('numGroupsInput').value = '3';
            document.getElementById('customAnimalInput').value = '';
            
            showWorksheet();
        }

        function initializeGroupData(projectId, groupName) {
            const project = state.projects[projectId];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;
            
            MODES.forEach(mode => {
                const key = `${projectId}_${groupName}_${mode}`;
                const observations = MODE_OBSERVATIONS[mode];
                const data = [];
                
                if (mode === 'Body Weight') {
                    ['before', 'after'].forEach(time => {
                        observations.forEach(obs => {
                            const row = { time, observation: obs };
                            for (let i = 1; i <= project.animalsPerGroup; i++) {
                                row[`${animalType}_${i}`] = animalType === 'mouse' ? '25.0' : '250.0';
                            }
                            data.push(row);
                        });
                    });
                } else {
                    [0].forEach(time => {
                        observations.forEach(obs => {
                            const row = { time, observation: obs };
                            for (let i = 1; i <= project.animalsPerGroup; i++) {
                                if (mode === 'Body Temperature') {
                                    row[`${animalType}_${i}`] = '37.0';
                                } else if (['Autonomic and Sensorimotor Functions', 'Reflex Capabilities', 'Convulsive Behaviors and Excitability'].includes(mode)) {
                                    row[`${animalType}_${i}`] = 'normal';
                                } else {
                                    row[`${animalType}_${i}`] = '4';
                                }
                            }
                            data.push(row);
                        });
                    });
                }
                
                state.worksheetData[key] = data;
            });
        }

        function selectProject() {
            const select = document.getElementById('projectSelect');
            state.activeProject = select.value;
            state.activeGroup = null;
            updateUI();
        }

        function selectGroup() {
            const select = document.getElementById('groupSelect');
            state.activeGroup = select.value;
            if (state.activeGroup) {
                updateWorksheet();
                updateCharts();
            }
        }

        function updateUI() {
            // Update project select
            const projectSelect = document.getElementById('projectSelect');
            projectSelect.innerHTML = '<option value="">Select Project...</option>';
            Object.values(state.projects).forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                if (project.id === state.activeProject) option.selected = true;
                projectSelect.appendChild(option);
            });

            // Update group select
            const groupSelect = document.getElementById('groupSelect');
            groupSelect.innerHTML = '<option value="">Select Group...</option>';
            if (state.activeProject && state.projects[state.activeProject]) {
                state.projects[state.activeProject].groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    if (group === state.activeGroup) option.selected = true;
                    groupSelect.appendChild(option);
                });
            }

            // Update group checkboxes for charts
            updateGroupCheckboxes();
        }

        function updateGroupCheckboxes() {
            const container = document.getElementById('groupCheckboxes');
            if (!container) return;
            container.innerHTML = '';
            if (state.activeProject && state.projects[state.activeProject]) {
                state.projects[state.activeProject].groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'inline-flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '5px';
                    label.style.marginRight = '15px';
                    label.style.marginBottom = '10px';
                    label.style.cursor = 'pointer';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = group;
                    checkbox.checked = true;
                    checkbox.onchange = () => {
                        setTimeout(() => updateCharts(), 100);
                    };
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(group));
                    container.appendChild(label);
                });
                // Initialize selected groups
                state.selectedGroupsForChart = state.projects[state.activeProject].groups;
            }
        }

        function showWorksheet() {
            document.getElementById('worksheetArea').style.display = 'block';
            document.getElementById('summaryArea').style.display = 'none';
            document.getElementById('chartArea').style.display = 'none';
            document.getElementById('aiChatbotArea').style.display = 'none';
            if (state.activeProject && state.activeGroup) {
                updateWorksheet();
            }
        }

        function showSummary() {
            document.getElementById('worksheetArea').style.display = 'none';
            document.getElementById('summaryArea').style.display = 'block';
            document.getElementById('chartArea').style.display = 'none';
            document.getElementById('aiChatbotArea').style.display = 'none';
            if (state.activeProject && state.activeGroup) {
                updateSummary();
            }
        }

        function showCharts() {
            document.getElementById('worksheetArea').style.display = 'none';
            document.getElementById('summaryArea').style.display = 'none';
            document.getElementById('chartArea').style.display = 'block';
            document.getElementById('aiChatbotArea').style.display = 'none';
            if (state.activeProject) {
                updateGroupCheckboxes();
                updateCharts();
            } else {
                document.getElementById('chartCanvas').parentElement.innerHTML = '<p>Please create and select a project first</p>';
            }
        }

        function updateWorksheet() {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;

            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;
            const data = state.worksheetData[key] || [];
            const project = state.projects[state.activeProject];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;

            // Render table
            renderWorksheetTable(data, animalType, project.animalsPerGroup, 'worksheetTable');
            renderWorksheetTable(data, animalType, project.animalsPerGroup, 'worksheetTableAuto');
        }

        function renderWorksheetTable(data, animalType, numAnimals, containerId) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No data available. Please add time points.</p>';
                return;
            }

            // Sort data by time
            const sortedData = [...data].sort((a, b) => {
                if (typeof a.time === 'string') return a.time.localeCompare(b.time);
                return a.time - b.time;
            });

            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;

            let html = '<table><thead><tr><th>Time</th><th>Observation</th>';
            for (let i = 1; i <= numAnimals; i++) {
                html += `<th>${animalType}_${i}</th>`;
            }
            html += '</tr></thead><tbody>';

            sortedData.forEach((row, idx) => {
                const originalIdx = data.indexOf(row);
                html += `<tr><td>${row.time}</td><td>${row.observation}</td>`;
                for (let i = 1; i <= numAnimals; i++) {
                    const col = `${animalType}_${i}`;
                    const value = row[col] || '';
                    html += `<td><input type="text" value="${value}" data-key="${key}" data-row="${originalIdx}" data-col="${col}" onchange="updateCell(this)" onblur="autoSaveCell(this)"></td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateCell(input) {
            const row = parseInt(input.dataset.row);
            const col = input.dataset.col;
            const key = input.dataset.key;
            if (state.worksheetData[key] && state.worksheetData[key][row]) {
                state.worksheetData[key][row][col] = input.value;
            }
        }

        function autoSaveCell(input) {
            if (state.currentTab === 'auto') {
                const key = input.dataset.key;
                saveToLocalStorage();
                showAlert('Data saved automatically', 'success');
            }
        }

        function addTimePoint() {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;
            
            const input = state.currentTab === 'auto' ? 
                document.getElementById('newTimeInputAuto') : 
                document.getElementById('newTimeInput');
            const newTime = parseInt(input.value);
            
            if (isNaN(newTime)) {
                alert('Please enter a valid time');
                return;
            }

            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;
            const data = state.worksheetData[key] || [];
            const project = state.projects[state.activeProject];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;
            const observations = MODE_OBSERVATIONS[state.activeMode];

            // Check if time already exists
            if (data.some(row => row.time === newTime)) {
                alert('This time point already exists');
                return;
            }

            // Add new rows for this time point
            observations.forEach(obs => {
                const row = { time: newTime, observation: obs };
                for (let i = 1; i <= project.animalsPerGroup; i++) {
                    if (state.activeMode === 'Body Temperature') {
                        row[`${animalType}_${i}`] = '37.0';
                    } else if (['Autonomic and Sensorimotor Functions', 'Reflex Capabilities', 'Convulsive Behaviors and Excitability'].includes(state.activeMode)) {
                        row[`${animalType}_${i}`] = 'normal';
                    } else {
                        row[`${animalType}_${i}`] = '4';
                    }
                }
                data.push(row);
            });

            // Sort by time
            data.sort((a, b) => {
                if (typeof a.time === 'string') return a.time.localeCompare(b.time);
                return a.time - b.time;
            });

            state.worksheetData[key] = data;
            
            // Synchronize across all modes
            synchronizeTimePoints(newTime);
            
            saveToLocalStorage();
            updateWorksheet();
            showAlert(`Time point ${newTime} min added and synchronized across all modes`, 'success');
            input.value = '';
        }

        function synchronizeTimePoints(newTime) {
            if (!state.activeProject) return;
            
            const project = state.projects[state.activeProject];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;
            
            project.groups.forEach(group => {
                MODES.forEach(mode => {
                    if (mode === 'Body Weight') return; // Skip Body Weight
                    
                    const key = `${state.activeProject}_${group}_${mode}`;
                    const data = state.worksheetData[key] || [];
                    const observations = MODE_OBSERVATIONS[mode];
                    
                    // Check if time already exists
                    if (data.some(row => row.time === newTime)) return;
                    
                    // Add new rows
                    observations.forEach(obs => {
                        const row = { time: newTime, observation: obs };
                        for (let i = 1; i <= project.animalsPerGroup; i++) {
                            if (mode === 'Body Temperature') {
                                row[`${animalType}_${i}`] = '37.0';
                            } else if (['Autonomic and Sensorimotor Functions', 'Reflex Capabilities', 'Convulsive Behaviors and Excitability'].includes(mode)) {
                                row[`${animalType}_${i}`] = 'normal';
                            } else {
                                row[`${animalType}_${i}`] = '4';
                            }
                        }
                        data.push(row);
                    });
                    
                    // Sort by time
                    data.sort((a, b) => {
                        if (typeof a.time === 'string') return a.time.localeCompare(b.time);
                        return a.time - b.time;
                    });
                    
                    state.worksheetData[key] = data;
                });
            });
        }

        function saveData() {
            saveToLocalStorage();
            showAlert('Data saved successfully', 'success');
        }

        function fillRandomData() {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;
            
            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;
            const data = state.worksheetData[key] || [];
            const project = state.projects[state.activeProject];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;

            data.forEach(row => {
                for (let i = 1; i <= project.animalsPerGroup; i++) {
                    const col = `${animalType}_${i}`;
                    if (state.activeMode === 'Body Temperature') {
                        row[col] = (36 + Math.random() * 2).toFixed(1);
                    } else if (state.activeMode === 'Body Weight') {
                        row[col] = (animalType === 'mouse' ? 20 + Math.random() * 10 : 200 + Math.random() * 100).toFixed(1);
                    } else if (['Autonomic and Sensorimotor Functions', 'Reflex Capabilities', 'Convulsive Behaviors and Excitability'].includes(state.activeMode)) {
                        row[col] = Math.random() > 0.7 ? 'abnormal' : 'normal';
                    } else {
                        row[col] = Math.floor(Math.random() * 9).toString();
                    }
                }
            });

            state.worksheetData[key] = data;
            updateWorksheet();
            showAlert('Random data filled', 'success');
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data?')) {
                if (state.activeProject && state.activeGroup) {
                    const project = state.projects[state.activeProject];
                    initializeGroupData(state.activeProject, state.activeGroup);
                    updateWorksheet();
                    showAlert('Data reset', 'info');
                }
            }
        }

        function switchTab(tab) {
            state.currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            updateWorksheet();
        }

        function updateSummary() {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;
            
            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;
            const data = state.worksheetData[key] || [];
            const project = state.projects[state.activeProject];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;
            
            let html = '<div class="summary-table"><table><thead><tr><th>Time</th><th>Observation</th><th>Mean Score</th><th>Status</th></tr></thead><tbody>';
            
            const times = [...new Set(data.map(r => r.time))].sort((a, b) => {
                if (typeof a === 'string') return a.localeCompare(b);
                return a - b;
            });
            
            times.forEach(time => {
                const timeData = data.filter(r => r.time === time);
                const observations = [...new Set(timeData.map(r => r.observation))];
                
                observations.forEach(obs => {
                    const obsData = timeData.filter(r => r.observation === obs);
                    const scores = [];
                    
                    obsData.forEach(row => {
                        for (let i = 1; i <= project.animalsPerGroup; i++) {
                            const col = `${animalType}_${i}`;
                            const val = row[col];
                            if (val) {
                                if (state.activeMode === 'Body Temperature' || state.activeMode === 'Body Weight' || state.activeMode === 'General Behavior') {
                                    const num = parseFloat(val);
                                    if (!isNaN(num)) scores.push(num);
                                } else {
                                    // Binary mode
                                    if (val.toLowerCase() === 'abnormal' || val.toLowerCase() === 'pale' || val.toLowerCase() === 'cyanosis') {
                                        scores.push(1);
                                    } else {
                                        scores.push(0);
                                    }
                                }
                            }
                        }
                    });
                    
                    const mean = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
                    let status = 'normal';
                    
                    if (state.activeMode === 'Body Temperature') {
                        status = (mean >= 36 && mean <= 38) ? 'normal' : 'abnormal';
                    } else if (state.activeMode === 'General Behavior') {
                        status = (mean >= 2 && mean <= 6) ? 'normal' : 'abnormal';
                    } else {
                        // Binary modes - percentage abnormal
                        const abnormalCount = scores.filter(s => s === 1).length;
                        const abnormalPct = (abnormalCount / scores.length) * 100;
                        status = abnormalPct > 0 ? 'abnormal' : 'normal';
                    }
                    
                    html += `<tr>
                        <td>${time}</td>
                        <td>${obs}</td>
                        <td>${mean.toFixed(2)}</td>
                        <td><span class="status-badge status-${status}">${status}</span></td>
                    </tr>`;
                });
            });
            
            html += '</tbody></table></div>';
            document.getElementById('summaryContent').innerHTML = html;
        }

        function showSummaryType(type) {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateSummary();
        }

        function updateCharts() {
            if (!state.activeProject) {
                document.getElementById('chartCanvas').parentElement.innerHTML = '<p>Please create and select a project first</p>';
                return;
            }
            
            const checkboxes = document.querySelectorAll('#groupCheckboxes input[type="checkbox"]:checked');
            const selectedGroups = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedGroups.length === 0) {
                const canvas = document.getElementById('chartCanvas');
                if (canvas && canvas.parentElement) {
                    canvas.parentElement.innerHTML = '<p>Please select at least one group</p>';
                }
                return;
            }
            
            state.selectedGroupsForChart = selectedGroups;
            renderChart();
        }

        function renderChart() {
            const chartWrapper = document.querySelector('.chart-wrapper');
            if (!chartWrapper) return;
            
            // Clear previous chart
            chartWrapper.innerHTML = '<canvas id="chartCanvas"></canvas>';
            const canvas = document.getElementById('chartCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (state.currentChart) {
                state.currentChart.destroy();
            }
            
            const project = state.projects[state.activeProject];
            if (!project) return;
            
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;
            
            if (state.activeMode === 'Body Weight') {
                renderBodyWeightChart(ctx, project, animalType);
            } else if (state.activeMode === 'General Behavior') {
                renderGeneralBehaviorChart(ctx, project, animalType);
            } else if (state.activeMode === 'Body Temperature') {
                renderLineChart(ctx, project, animalType, 'Temperature (¬∞C)');
            } else {
                renderBinaryLineChart(ctx, project, animalType);
            }
        }

        function renderBodyWeightChart(ctx, project, animalType) {
            const datasets = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3'];
            const labels = [];
            const beforeMeans = [];
            const afterMeans = [];
            
            state.selectedGroupsForChart.forEach((group, idx) => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                
                const beforeData = data.find(r => String(r.time).toLowerCase() === 'before');
                const afterData = data.find(r => String(r.time).toLowerCase() === 'after');
                
                if (beforeData && afterData) {
                    const beforeValues = [];
                    const afterValues = [];
                    
                    for (let i = 1; i <= project.animalsPerGroup; i++) {
                        const col = `${animalType}_${i}`;
                        const before = parseFloat(beforeData[col]) || 0;
                        const after = parseFloat(afterData[col]) || 0;
                        if (before > 0) beforeValues.push(before);
                        if (after > 0) afterValues.push(after);
                    }
                    
                    if (beforeValues.length > 0 && afterValues.length > 0) {
                        const beforeMean = beforeValues.reduce((a, b) => a + b, 0) / beforeValues.length;
                        const afterMean = afterValues.reduce((a, b) => a + b, 0) / afterValues.length;
                        
                        labels.push(group);
                        beforeMeans.push(beforeMean);
                        afterMeans.push(afterMean);
                    }
                }
            });
            
            if (labels.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<p>No data available for Body Weight chart</p>';
                return;
            }
            
            datasets.push({
                label: 'Before',
                data: beforeMeans,
                backgroundColor: colors[0] + '80',
                borderColor: colors[0],
                borderWidth: 2
            });
            
            datasets.push({
                label: 'After',
                data: afterMeans,
                backgroundColor: colors[1] + '80',
                borderColor: colors[1],
                borderWidth: 2
            });
            
            state.currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Weight (g)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Body Weight Comparison - Before vs After'
                        },
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        function renderGeneralBehaviorChart(ctx, project, animalType) {
            // Get all unique times
            const allTimes = new Set();
            state.selectedGroupsForChart.forEach(group => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                data.forEach(r => allTimes.add(r.time));
            });
            
            const sortedTimes = Array.from(allTimes).sort((a, b) => {
                if (typeof a === 'string') return a.localeCompare(b);
                return a - b;
            });
            
            const datasets = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3'];
            
            state.selectedGroupsForChart.forEach((group, idx) => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                const means = [];
                
                sortedTimes.forEach(time => {
                    const timeData = data.filter(r => r.time === time);
                    const scores = [];
                    
                    timeData.forEach(row => {
                        for (let i = 1; i <= project.animalsPerGroup; i++) {
                            const col = `${animalType}_${i}`;
                            const val = parseFloat(row[col]);
                            if (!isNaN(val)) scores.push(val);
                        }
                    });
                    
                    const mean = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
                    means.push(mean);
                });
                
                datasets.push({
                    label: group,
                    data: means,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '40',
                    tension: 0.4
                });
            });
            
            state.currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedTimes.map(t => t + ' min'),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Mean Score'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'General Behavior - Time Series'
                        }
                    }
                }
            });
        }

        function renderLineChart(ctx, project, animalType, yLabel) {
            const allTimes = new Set();
            state.selectedGroupsForChart.forEach(group => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                data.forEach(r => allTimes.add(r.time));
            });
            
            const sortedTimes = Array.from(allTimes).sort((a, b) => {
                if (typeof a === 'string') return a.localeCompare(b);
                return a - b;
            });
            
            const datasets = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3'];
            
            state.selectedGroupsForChart.forEach((group, idx) => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                const means = [];
                
                sortedTimes.forEach(time => {
                    const timeData = data.filter(r => r.time === time);
                    const values = [];
                    
                    timeData.forEach(row => {
                        for (let i = 1; i <= project.animalsPerGroup; i++) {
                            const col = `${animalType}_${i}`;
                            const val = parseFloat(row[col]);
                            if (!isNaN(val)) values.push(val);
                        }
                    });
                    
                    const mean = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                    means.push(mean);
                });
                
                datasets.push({
                    label: group,
                    data: means,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '40',
                    tension: 0.4
                });
            });
            
            state.currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedTimes.map(t => t + ' min'),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: yLabel
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${state.activeMode} - Time Series`
                        }
                    }
                }
            });
        }

        function renderBinaryLineChart(ctx, project, animalType) {
            const allTimes = new Set();
            state.selectedGroupsForChart.forEach(group => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                data.forEach(r => allTimes.add(r.time));
            });
            
            const sortedTimes = Array.from(allTimes).sort((a, b) => {
                if (typeof a === 'string') return a.localeCompare(b);
                return a - b;
            });
            
            const datasets = [];
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3'];
            
            state.selectedGroupsForChart.forEach((group, idx) => {
                const key = `${state.activeProject}_${group}_${state.activeMode}`;
                const data = state.worksheetData[key] || [];
                const percentages = [];
                
                sortedTimes.forEach(time => {
                    const timeData = data.filter(r => r.time === time);
                    let total = 0;
                    let abnormal = 0;
                    
                    timeData.forEach(row => {
                        for (let i = 1; i <= project.animalsPerGroup; i++) {
                            const col = `${animalType}_${i}`;
                            const val = String(row[col] || '').toLowerCase();
                            total++;
                            if (val === 'abnormal' || val === 'pale' || val === 'cyanosis') {
                                abnormal++;
                            }
                        }
                    });
                    
                    const pct = total > 0 ? (abnormal / total) * 100 : 0;
                    percentages.push(pct);
                });
                
                datasets.push({
                    label: group,
                    data: percentages,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '40',
                    tension: 0.4
                });
            });
            
            state.currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedTimes.map(t => t + ' min'),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Abnormal (%)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${state.activeMode} - Abnormal Percentage Over Time`
                        }
                    }
                }
            });
        }

        function exportCSV() {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;
            
            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;
            const data = state.worksheetData[key] || [];
            
            if (!data.length) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${row[h] || ''}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.activeGroup}_${state.activeMode}_${Date.now()}.csv`;
            a.click();
        }

        function downloadTemplate() {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;
            
            const project = state.projects[state.activeProject];
            const animalType = project.animalType === 'custom' ? project.customAnimal : project.animalType;
            const observations = MODE_OBSERVATIONS[state.activeMode];
            
            const headers = ['time', 'observation'];
            for (let i = 1; i <= project.animalsPerGroup; i++) {
                headers.push(`${animalType}_${i}`);
            }
            
            const rows = [];
            if (state.activeMode === 'Body Weight') {
                ['before', 'after'].forEach(time => {
                    observations.forEach(obs => {
                        rows.push([time, obs, ...Array(project.animalsPerGroup).fill('')]);
                    });
                });
            } else {
                [0].forEach(time => {
                    observations.forEach(obs => {
                        rows.push([time, obs, ...Array(project.animalsPerGroup).fill('')]);
                    });
                });
            }
            
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `template_${state.activeMode}_${Date.now()}.csv`;
            a.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                if (file.name.endsWith('.csv')) {
                    Papa.parse(e.target.result, {
                        header: true,
                        complete: (results) => {
                            loadDataFromCSV(results.data);
                        }
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    loadDataFromCSV(jsonData);
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function loadDataFromCSV(data) {
            if (!state.activeProject || !state.activeGroup || !state.activeMode) return;
            
            const key = `${state.activeProject}_${state.activeGroup}_${state.activeMode}`;
            state.worksheetData[key] = data;
            saveToLocalStorage();
            updateWorksheet();
            showAlert('Data loaded successfully', 'success');
        }

        function exportProject() {
            const exportData = {
                projects: state.projects,
                worksheetData: state.worksheetData,
                activeProject: state.activeProject,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fob_project_${Date.now()}.json`;
            a.click();
        }

        function importProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        state.projects = data.projects || {};
                        state.worksheetData = data.worksheetData || {};
                        state.activeProject = data.activeProject || null;
                        if (state.activeProject && state.projects[state.activeProject]) {
                            state.activeGroup = state.projects[state.activeProject].groups[0] || null;
                        }
                        saveToLocalStorage();
                        updateUI();
                        showAlert('Project imported successfully', 'success');
                    } catch (error) {
                        alert('Error importing project: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function deleteProject() {
            if (!state.activeProject) {
                alert('No project selected');
                return;
            }

            if (confirm('Are you sure you want to delete this project?')) {
                const projectId = state.activeProject;
                delete state.projects[projectId];
                state.activeProject = null;
                state.activeGroup = null;
                
                // Clean up worksheet data
                Object.keys(state.worksheetData).forEach(key => {
                    if (key.startsWith(projectId + '_')) {
                        delete state.worksheetData[key];
                    }
                });
                
                saveToLocalStorage();
                updateUI();
                showAlert('Project deleted', 'info');
            }
        }

        function showAIChatbot() {
            document.getElementById('aiChatbotArea').style.display = 'block';
            document.getElementById('worksheetArea').style.display = 'none';
            document.getElementById('summaryArea').style.display = 'none';
            document.getElementById('chartArea').style.display = 'none';
            
            if (state.chatMessages.length === 0) {
                addChatMessage('assistant', 'Hello! I\'m your AI assistant. How can I help you with FOB test analysis?');
            }
        }

        function addChatMessage(role, content) {
            state.chatMessages.push({ role, content, timestamp: new Date().toLocaleTimeString() });
            renderChatMessages();
        }

        function renderChatMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = state.chatMessages.map(msg => {
                const align = msg.role === 'user' ? 'right' : 'left';
                const bgColor = msg.role === 'user' ? '#667eea' : '#f0f0f0';
                const textColor = msg.role === 'user' ? 'white' : '#333';
                return `
                    <div style="text-align: ${align}; margin: 10px 0;">
                        <div style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 10px; background: ${bgColor}; color: ${textColor};">
                            ${msg.content}
                            <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">${msg.timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                const responses = [
                    'I understand your question about FOB testing. Let me help you analyze the data.',
                    'Based on the data you\'ve entered, I can provide insights and recommendations.',
                    'For FOB test analysis, it\'s important to track behavioral changes over time.',
                    'Would you like me to generate a report or create visualizations for your data?'
                ];
                addChatMessage('assistant', responses[Math.floor(Math.random() * responses.length)]);
            }, 1000);
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function generateAIReport() {
            showAlert('AI Report generation feature - Coming soon!', 'info');
        }

        function generatePowerPoint() {
            showAlert('PowerPoint generation feature - Coming soon!', 'info');
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('fob_dashboard_state', JSON.stringify({
                    projects: state.projects,
                    activeProject: state.activeProject,
                    activeGroup: state.activeGroup,
                    activeMode: state.activeMode,
                    worksheetData: state.worksheetData,
                    language: state.language
                }));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('fob_dashboard_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.projects = data.projects || {};
                    state.activeProject = data.activeProject || null;
                    state.activeGroup = data.activeGroup || null;
                    state.activeMode = data.activeMode || 'General Behavior';
                    state.worksheetData = data.worksheetData || {};
                    state.language = data.language || 'en';
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
